{"version":3,"sources":["../../lib/cluster/cluster.ts"],"names":["TimeoutError","Error","isTimeout","remove","array","object","index","indexOf","splice","Cluster","constructor","workers","require","template","task","callback","_execute","_workerCount","Math","max","os","cpus","length","_require","_template","start","_inactiveWorkers","_activeWorkers","_queue","async","queue","worker","ensureWorkers","shutdown","clearWorkerTimeout","removeAllListeners","kill","total","i","forkWorker","send","initialize","push","path","join","__dirname","popWorker","setImmediate","shift","clearTimeout","executionTimeout","finishWorker","removeWorker","execute","code","context","timeout","item","Promise","resolve","reject","on","message","error","setTimeout","JSON","stringify"],"mappings":"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","sourcesContent":["import { fork, ChildProcess } from 'child_process';\nimport path from 'path';\nimport async from 'async';\nimport os from 'os';\n\nclass TimeoutError extends Error {\n  get isTimeout() {\n    return true;\n  }\n}\n\nfunction remove(array, object) {\n  const index = array.indexOf(object);\n\n  if (index > -1) {\n    array.splice(index, 1);\n  }\n}\n\ninterface Item {\n  code: string;\n  timeout: number;\n  context: any;\n}\n\nexport default class Cluster {\n  _workerCount: number;\n\n  _require: string;\n\n  _template: string;\n\n  _inactiveWorkers: ChildProcess[];\n\n  _activeWorkers: ChildProcess[];\n\n  _queue: async.AsyncQueue<Item>;\n\n  constructor(\n    { workers, require, template } =\n    { workers: null, require: null, template: null }\n  ) {\n    this._workerCount = workers || Math.max(os.cpus().length, 4);\n    this._require = require;\n    this._template = template;\n    this.start();\n  }\n\n  start() {\n    this._inactiveWorkers = [];\n    this._activeWorkers = [];\n    this._queue = async.queue(this.worker, this._workerCount);\n    this.ensureWorkers();\n  }\n\n  shutdown() {\n    for (const worker of this._inactiveWorkers) {\n      this.clearWorkerTimeout(worker);\n      worker.removeAllListeners();\n      worker.kill();\n    }\n\n    for (const worker of this._activeWorkers) {\n      this.clearWorkerTimeout(worker);\n      worker.removeAllListeners();\n      worker.kill();\n    }\n\n    this._inactiveWorkers = [];\n    this._activeWorkers = [];\n\n    if (this._queue) {\n      this._queue.kill();\n    }\n\n    this._queue = async.queue(this.worker, this._workerCount);\n  }\n\n  worker = (task, callback) => {\n    this._execute(task, callback);\n  };\n\n  ensureWorkers() {\n    const total = this._inactiveWorkers.length + this._activeWorkers.length;\n\n    for (let i = 0; i < this._workerCount - total; ++i) {\n      const worker = this.forkWorker();\n\n      worker.send({ initialize: true,\n                    require: this._require,\n                    template: this._template });\n\n      this._inactiveWorkers.push(worker);\n    }\n  }\n\n  forkWorker() {\n    return fork(path.join(__dirname, 'worker'));\n  }\n\n  popWorker(callback) {\n    this.ensureWorkers();\n\n    if (this._inactiveWorkers.length === 0) {\n      setImmediate(() => {\n        this.popWorker(callback);\n      });\n\n      return;\n    }\n\n    const worker = this._inactiveWorkers.shift();\n\n    this._activeWorkers.push(worker);\n\n    if (this._activeWorkers.length + this._inactiveWorkers.length !== this._workerCount) {\n      throw new Error('invalid worker count');\n    }\n\n    callback(worker);\n  }\n\n  clearWorkerTimeout(worker) {\n    clearTimeout(worker.executionTimeout);\n    worker.executionTimeout = null;\n  }\n\n  finishWorker(worker) {\n    this.clearWorkerTimeout(worker);\n    remove(this._activeWorkers, worker);\n    this._inactiveWorkers.push(worker);\n  }\n\n  removeWorker(worker) {\n    this.clearWorkerTimeout(worker);\n\n    worker.kill();\n    worker.removeAllListeners();\n\n    remove(this._activeWorkers, worker);\n    remove(this._inactiveWorkers, worker);\n\n    this.ensureWorkers();\n  }\n\n  execute({ code, context, timeout }) {\n    const item = {\n      code, timeout, context\n    };\n\n    return new Promise((resolve, reject) => {\n      this._queue.push(item, resolve);\n    });\n  }\n\n  _execute({ code, context, timeout }, callback) {\n    this.popWorker((worker) => {\n      worker.removeAllListeners();\n\n      worker.on('message', (message) => {\n        this.finishWorker(worker);\n\n        callback(message);\n      });\n\n      worker.on('error', (message) => {\n        this.removeWorker(worker);\n\n        callback({ error: new Error('worker error') });\n      });\n\n      worker.on('disconnect', () => {\n        this.removeWorker(worker);\n\n        callback({ error: new Error('worker disconnected') });\n      });\n\n      worker.on('exit', (message) => {\n        this.removeWorker(worker);\n      });\n\n      if (timeout > 0) {\n        worker.executionTimeout = setTimeout(() => {\n          // worker.kill();\n          this.removeWorker(worker);\n          callback({ error: new TimeoutError('timeout') });\n        }, timeout);\n      }\n\n      worker.send({ code, context: JSON.stringify(context || {}) });\n    });\n  }\n}\n"],"file":"cluster.js"}