{"version":3,"sources":["../lib/index.js"],"names":["TimeoutError","Error","isTimeout","remove","array","object","index","indexOf","splice","Sandbox","constructor","options","worker","task","callback","_execute","code","timeout","_workerCount","workers","_require","require","start","_inactiveWorkers","_activeWorkers","_queue","queue","ensureWorkers","shutdown","removeAllListeners","kill","total","length","i","forkWorker","send","push","join","__dirname","popWorker","setTimeout","shift","finishWorker","clearTimeout","executionTimeout","removeWorker","execute","item","promise","itemResolve","itemReject","Promise","resolve","reject","err","value","on","message"],"mappings":"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","file":"index.js","sourcesContent":["import {fork} from 'child_process';\nimport path from 'path';\nimport async from 'async';\n\nclass TimeoutError extends Error {\n  get isTimeout() {\n    return true;\n  }\n}\n\nfunction remove(array, object) {\n  const index = array.indexOf(object);\n\n  if (index > -1) {\n    array.splice(index, 1);\n  }\n}\n\nexport default class Sandbox {\n  constructor(options = {}) {\n    this._workerCount = options.workers || 4;\n    this._require = options.require;\n    this.start();\n  }\n\n  start() {\n    this._inactiveWorkers = [];\n    this._activeWorkers = [];\n    this._queue = async.queue(this.worker, this._workerCount);\n    this.ensureWorkers();\n  }\n\n  shutdown() {\n    for (const worker of this._inactiveWorkers) {\n      worker.removeAllListeners();\n      worker.kill();\n    }\n\n    for (const worker of this._activeWorkers) {\n      worker.removeAllListeners();\n      worker.kill();\n    }\n\n    this._inactiveWorkers = [];\n    this._activeWorkers = [];\n\n    if (this._queue) {\n      this._queue.kill();\n    }\n\n    this._queue = async.queue(this.worker, this._workerCount);\n  }\n\n  worker = (task, callback) => {\n    this._execute(task.code, task.timeout, callback);\n  }\n\n  ensureWorkers() {\n    const total = this._inactiveWorkers.length + this._activeWorkers;\n\n    for (let i = 0; i < this._workerCount - total; ++i) {\n      const worker = this.forkWorker();\n\n      if (this._require) {\n        worker.send({require: this._require});\n      }\n\n      this._inactiveWorkers.push(worker);\n    }\n  }\n\n  forkWorker() {\n    return fork(path.join(__dirname, 'worker'));\n  }\n\n  popWorker(callback) {\n    this.ensureWorkers();\n\n    if (this._inactiveWorkers.length === 0) {\n      setTimeout(() => {\n        this.popWorker(callback);\n      }, 1);\n\n      return;\n    }\n\n    const worker = this._inactiveWorkers.shift();\n    this._activeWorkers.push(worker);\n\n    if (this._activeWorkers.length + this._inactiveWorkers.length !== this._workerCount) {\n      throw new Error('invalid worker count');\n    }\n\n    callback(worker);\n  }\n\n  finishWorker(worker) {\n    clearTimeout(worker.executionTimeout);\n    worker.executionTimeout = null;\n    remove(this._activeWorkers, worker);\n    this._inactiveWorkers.push(worker);\n  }\n\n  removeWorker(worker) {\n    clearTimeout(worker.executionTimeout);\n    worker.executionTimeout = null;\n    worker.removeAllListeners();\n    remove(this._activeWorkers, worker);\n    remove(this._inactiveWorkers, worker);\n    this.ensureWorkers();\n  }\n\n  execute(code, timeout, callback) {\n    const item = {\n      code, timeout\n    };\n\n    let promise = null;\n\n    if (callback == null) {\n      let itemResolve = null;\n      let itemReject = null;\n\n      promise = new Promise((resolve, reject) => {\n        itemResolve = resolve;\n        itemReject = reject;\n      });\n\n      callback = (err, value) => {\n        if (err) {\n          return itemReject(value);\n        }\n\n        return itemResolve(value);\n      };\n    }\n\n    this._queue.push(item, callback);\n\n    return promise;\n  }\n\n  _execute(code, timeout, callback) {\n    this.popWorker((worker) => {\n      worker.removeAllListeners();\n\n      worker.on('message', (message) => {\n        this.finishWorker(worker);\n        callback(message.err, message.value);\n      });\n\n      worker.on('error', (message) => {\n        this.removeWorker(worker);\n      });\n\n      worker.on('disconnect', () => {\n        this.removeWorker(worker);\n      });\n\n      worker.on('exit', (message) => {\n        this.removeWorker(worker);\n      });\n\n      if (timeout > 0) {\n        worker.executionTimeout = setTimeout(() => {\n          this.removeWorker(worker);\n          worker.kill();\n          callback(new TimeoutError('timeout'));\n        }, timeout);\n      }\n\n      worker.send({code});\n    });\n  }\n}\n"]}