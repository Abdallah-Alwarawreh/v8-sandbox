{"version":3,"sources":["../lib/sandbox.js"],"names":["TimeoutError","Error","isTimeout","Socket","constructor","socket","sandbox","console","log","data","message","JSON","parse","callback","args","worker","send","type","id","respond","result","json","stringify","length","Buffer","byteLength","buffer","alloc","writeInt32LE","write","dispatch","ex","error","name","stack","resume","on","handleClose","handleData","handleError","handleDrain","handleTimeout","handleEnd","Sandbox","socketName","server","net","createServer","handleConnection","handleListening","listen","forkWorker","queue","kill","path","join","__dirname","process","platform","cwd","execute","code","context","timeout","wrappedCallback","called","push","executeNext","finishItem","item","pop","removeAllListeners","executionTimeout","setTimeout","shutdown","close","params","setResult","httpRequest","clearTimeout","value","timerID","options","sync","err","response","body","isBuffer","toString"],"mappings":"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","sourcesContent":["import path from 'path';\nimport { fork } from 'child_process';\nimport net from 'net';\nimport { v4 as uuid } from 'uuid';\nimport request from 'request';\n\nclass TimeoutError extends Error {\n  get isTimeout() {\n    return true;\n  }\n}\n\nclass Socket {\n  constructor(socket, sandbox) {\n    this.sandbox = sandbox;\n    this.socket = socket;\n    this.socket.on('close', this.handleClose);\n    this.socket.on('data', this.handleData);\n    this.socket.on('error', this.handleError);\n    this.socket.on('drain', this.handleDrain);\n    this.socket.on('timeout', this.handleTimeout);\n    this.socket.on('end', this.handleEnd);\n  }\n\n  handleClose = () => {\n    console.log('socket closed');\n  }\n\n  handleData = (data) => {\n    // console.log('socket data', data.toString());\n\n    const message = JSON.parse(data);\n\n    const callback = (...args) => {\n      this.sandbox.worker.send({ type: 'callback', id: message.id, args });\n    };\n\n    const respond = (result) => {\n      const json = JSON.stringify({ id: message.id, result });\n      const length = Buffer.byteLength(json, 'utf8');\n      const buffer = Buffer.alloc(length + 4);\n  \n      buffer.writeInt32LE(length);\n      buffer.write(json, 4);\n  \n      // console.log('writing json', json);\n      this.socket.write(buffer);\n    }\n\n    try {\n      this.sandbox.dispatch(message, respond, callback);\n    } catch (ex) {\n      return respond({\n        error: {\n          name: ex.name,\n          message: ex.message,\n          stack: ex.stack\n        }\n      });\n    }\n  }\n\n  handleError = (error) => {\n    console.log('socket error', error);\n  }\n\n  handleTimeout = () => {\n    console.log('socket timeout');\n  }\n\n  handleDrain = () => {\n    console.log('socket drain');\n    this.socket.resume();\n  }\n\n  handleEnd = () => {\n    console.log('socket end');\n  }\n}\n\nexport default class Sandbox {\n  constructor() {\n    this.id = uuid();\n\n    this.server = net.createServer();\n\n    this.server.on('close', this.handleClose);\n    this.server.on('connection', this.handleConnection);\n    this.server.on('error', this.handleError);\n    this.server.on('listening', this.handleListening);\n\n    this.server.listen(this.socketName);\n\n    this.forkWorker();\n\n    this.queue = [];\n  }\n\n  forkWorker() {\n    if (this.worker) {\n      this.worker.kill();\n      this.worker = null;\n    }\n\n    this.worker = fork(path.join(__dirname, 'worker'), [ this.socketName ]);\n  }\n\n  get socketName() {\n    return process.platform === 'win32' ? path.join('\\\\\\\\?\\\\pipe', process.cwd(), this.id)\n                                        : `/tmp/${ this.id }`;\n  }\n\n  handleClose = () => {\n    console.log('server closed');\n  }\n\n  handleConnection = (socket) => {\n    // console.log('server connection');\n    this.socket = new Socket(socket, this);\n  }\n\n  handleError = (error) => {\n    console.log('server error', error);\n  }\n\n  handleListening = () => {\n    console.log('server listening', this.socketName);\n  }\n\n  execute({code, context, timeout}, callback) {\n    const wrappedCallback = (...args) => {\n      if (callback == null || callback.called) {\n        return;\n      }\n\n      callback.called = true;\n\n      callback(...args);\n    };\n\n    this.queue.push({code, context, timeout, callback: wrappedCallback});\n\n    this.executeNext();\n  }\n\n  finishItem() {\n    this.item = null;\n    this.executeNext();\n  }\n\n  executeNext() {\n    if (this.item || this.queue.length === 0) {\n      return;\n    }\n\n    this.item = this.queue.pop();\n\n    const { worker, item } = this;\n\n    worker.removeAllListeners();\n\n    worker.on('error', (error) => {\n      console.error('worker:error', error);\n\n      this.forkWorker();\n\n      item.callback({ error: new Error('worker error') });\n\n      this.finishItem();\n    });\n\n    this.worker.on('exit', () => {\n      // console.error('worker:exit', worker.exitCode);\n    });\n\n    if (item.timeout > 0) {\n      worker.executionTimeout = setTimeout(() => {\n        worker.kill();\n\n        this.forkWorker();\n\n        item.callback({ error: new TimeoutError('timeout') });\n  \n        this.finishItem();\n      }, item.timeout);\n    }\n\n    this.worker.send({type: 'execute', code: item.code, context: JSON.stringify(item.context || {})});\n  }\n\n  shutdown() {\n    this.worker.send({ type: 'exit' });\n    this.server.close(() => {\n      console.log('server shutdown');\n    })\n  }\n\n  dispatch({ name, args }, respond, callback) {\n    const params = [ ...args, respond, callback ];\n\n    switch (name) {\n      case 'setResult': {\n        return this.setResult(...params);\n      }\n      case 'httpRequest': {\n        return this.httpRequest(...params);\n      }\n      case 'setTimeout': {\n        return this.setTimeout(...params);\n      }\n      case 'clearTimeout': {\n        return this.clearTimeout(...params);\n      }\n      default: {\n        throw new Error(`${ name } is not a valid method`);\n      }\n    }\n\n    if (name === 'setResult') {\n      return respond({ value: this.setResult(...args) });\n    } if (name === 'test') {\n      return respond({ value: args });\n    } else if (name === 'testAsync') {\n      const timerID = setTimeout(() => {\n        callback(null, 7171717);\n      });\n\n      return respond({ value: +timerID });\n    } else {\n      throw new Error(`${ name } is not a valid method`);\n    }\n  }\n\n  setResult(result, respond, callback) {\n    // this.worker.send({ type: 'exit' });\n    this.item.callback(result);\n    this.finishItem();\n    respond({ value: null });\n  }\n\n  setTimeout(timeout, respond, callback) {\n    const timerID = setTimeout(callback, timeout);\n\n    respond({ value: +timerID });\n  }\n\n  clearTimeout(timerID, respond, callback) {\n    clearTimeout(timerID);\n\n    respond({ value: null });\n  }\n\n  httpRequest(options, respond, callback) {\n    const { sync } = options;\n\n    request(options, (err, response, body) => {\n      if (response && Buffer.isBuffer(response.body)) {\n        response.body = body = response.body.toString('base64');\n      }\n\n      if (sync) {\n        respond({ value: { err, response, body } });\n      } else {\n        callback(err, response, body);\n      }\n    });\n\n    if (!sync) {\n      respond({ value: null });\n    }\n  }\n}"],"file":"sandbox.js"}