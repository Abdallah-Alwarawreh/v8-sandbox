{"version":3,"sources":["../lib/sandbox.js"],"names":["NativeSandbox","require","Sandbox","RUNTIME","fs","readFileSync","path","join","__dirname","toString","tryParseJSON","value","JSON","parse","ex","constructor","template","native","load","syncFunctions","asyncFunctions","global","define","bind","defineAsync","name","fn","bootstrap","code","Object","entries","map","trim","stringify","initialize","Promise","resolve","reject","output","json","result","setImmediate","error","dispatch","eval","execute","finalize","callback","Error","invocation","finish","err","results","serialized","message","length","push","apply","parameters","args","dispatchSync","dispatchAsync","httpRequest","log","write","type","console","time","Date","util","format","options","response","body","Buffer","isBuffer","slice"],"mappings":"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","sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport request from 'request';\nimport util from 'util';\n\nconst NativeSandbox = require('bindings')('sandbox').Sandbox;\n\nconst RUNTIME = fs.readFileSync(path.join(__dirname, 'runtime.js')).toString();\n\nfunction tryParseJSON(value) {\n  try {\n    return JSON.parse(value);\n  } catch (ex) {\n    return null;\n  }\n}\n\nexport default class Sandbox {\n  constructor({require, template} = {}) {\n    this.native = new NativeSandbox();\n    this.require = require;\n    this.template = template;\n    this.load();\n  }\n\n  load() {\n    this.syncFunctions = {};\n    this.asyncFunctions = {};\n\n    global.define = this.define.bind(this);\n    global.defineAsync = this.defineAsync.bind(this);\n\n    if (this.require) {\n      require(this.require);\n    }\n  }\n\n  define(name, fn) {\n    this.syncFunctions[name] = fn;\n  }\n\n  defineAsync(name, fn) {\n    this.asyncFunctions[name] = fn;\n  }\n\n  bootstrap() {\n    const code = `\n      ${ Object.entries(this.syncFunctions).map(([name, fn]) => `define('${name}');`).join('\\n') }\n      ${ Object.entries(this.asyncFunctions).map(([name, fn]) => `defineAsync('${name}');`).join('\\n') }\n      ${ this.template }\n    `.trim();\n\n    return `\n      global._code = ${JSON.stringify(code)};\n      global._execute();\n    `;\n  }\n\n  initialize() {\n    return new Promise((resolve, reject) => {\n      this.output = [];\n\n      this.native.initialize(RUNTIME + this.bootstrap(), (json) => {\n        const result = tryParseJSON(json);\n\n        setImmediate(() => {\n          if (result && result.error) {\n            reject(result.error);\n          } else {\n            resolve(result && result.value);\n          }\n        });\n      }, this.dispatch.bind(this));\n    });\n  }\n\n  async eval(code) {\n    await this.initialize();\n\n    const result = await this.execute(code);\n\n    await this.finalize();\n\n    return {...result, output: this.output};\n  }\n\n  execute(code, callback) {\n    return new Promise((resolve, reject) => {\n      this.native.execute(code, (json) => {\n        let result = tryParseJSON(json);\n\n        if (result == null) {\n          result = { error: new Error('no result'), output: this.output };\n        }\n\n        setImmediate(() => {\n          resolve({...result, output: this.output});\n        });\n      }, this.dispatch.bind(this));\n    });\n  }\n\n  finalize() {\n    return new Promise((resolve) => {\n      this.native.finalize(() => {\n        setImmediate(resolve);\n      }, this.dispatch.bind(this));\n    });\n  }\n\n  // handle function calls from the sandbox\n  dispatch(invocation) {\n    const finish = (err, ...results) => {\n      const serialized = [\n        err != null ? {message: err.message} : null\n      ];\n\n      if (results && results.length) {\n        serialized.push.apply(serialized, results);\n      }\n\n      invocation.callback(invocation, JSON.stringify(serialized));\n    };\n\n    const parameters = tryParseJSON(invocation.args);\n\n    if (parameters == null) {\n      return finish(new Error('invalid invocation parameters'));\n    }\n\n    if (invocation.name === 'dispatchSync') {\n      return this.dispatchSync(parameters, finish);\n    } else if (invocation.name === 'dispatchAsync') {\n      return this.dispatchAsync(parameters, finish);\n    } else if (invocation.name === 'httpRequest') {\n      return this.httpRequest(...parameters, finish);\n    } else if (invocation.name === 'log') {\n      this.log(...parameters);\n      return finish(null);\n    } else if (invocation.name === 'error') {\n      this.error(...parameters);\n      return finish(null);\n    }\n\n    return finish(null);\n  }\n\n  log(...args) {\n    this.write({type: 'log', args});\n    console.log(...args);\n  }\n\n  error(...args) {\n    this.write({type: 'error', args});\n    console.error(...args);\n  }\n\n  write({type, args}) {\n    this.output.push({type, time: new Date(), message: util.format(...args)});\n  }\n\n  httpRequest(options, callback) {\n    request(options, (err, response, body) => {\n      if (response && Buffer.isBuffer(response.body)) {\n        response.body = body = response.body.toString('base64');\n      }\n\n      callback(err, response, body);\n    });\n  }\n\n  dispatchSync(args, callback) {\n    try {\n      const name = args[0];\n      const parameters = args.slice(1);\n      const fn = name && this.syncFunctions[name];\n\n      if (!fn) {\n        throw new Error(`function named '${name}' does not exist`);\n      }\n\n      callback(null, fn(...parameters));\n    } catch (err) {\n      callback(err);\n    }\n  }\n\n  dispatchAsync(args, callback) {\n    try {\n      const name = args[0];\n      const parameters = args.slice(1);\n      const fn = name && this.asyncFunctions[name];\n\n      if (!fn) {\n        throw new Error(`function named '${name}' does not exist`);\n      }\n\n      fn(...[ ...parameters, callback ]);\n    } catch (err) {\n      callback(err);\n    }\n  }\n}\n"],"file":"sandbox.js"}