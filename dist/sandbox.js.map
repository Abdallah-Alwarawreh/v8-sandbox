{"version":3,"sources":["../lib/sandbox.js"],"names":["NativeSandbox","require","Sandbox","RUNTIME","fs","readFileSync","path","join","__dirname","toString","LINECOUNT","split","length","tryParseJSON","value","JSON","parse","ex","SYNC_FUNCTIONS","ASYNC_FUNCTIONS","BLOCKING_FUNCTIONS","BLOCKING","Symbol","constructor","template","native","load","global","define","bind","defineAsync","defineBlocking","syncFunctions","asyncFunctions","blockingFunctions","name","fn","args","defines","Object","entries","map","initialize","Promise","resolve","reject","output","code","json","result","setImmediate","error","lineNumber","dispatch","eval","execute","finalize","callback","Error","invocation","finish","err","results","serialized","message","push","apply","stringify","parameters","dispatchSync","dispatchAsync","httpRequest","log","write","type","console","time","Date","util","format","options","response","body","Buffer","isBuffer","slice"],"mappings":"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","sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport request from 'request';\nimport util from 'util';\n\nconst NativeSandbox = require('bindings')('sandbox').Sandbox;\n\nconst RUNTIME = fs.readFileSync(path.join(__dirname, 'runtime.js')).toString();\nconst LINECOUNT = RUNTIME.split('\\n').length;\n\nfunction tryParseJSON(value) {\n  try {\n    return JSON.parse(value);\n  } catch (ex) {\n    return null;\n  }\n}\n\nconst SYNC_FUNCTIONS = {};\n\nconst ASYNC_FUNCTIONS = {};\n\nconst BLOCKING_FUNCTIONS = {};\n\nconst BLOCKING = Symbol('v8-sandbox-blocking');\n\nexport default class Sandbox {\n  constructor({require, template} = {}) {\n    this.native = new NativeSandbox();\n    this.require = require;\n    this.template = template;\n    this.load();\n  }\n\n  load() {\n    global.define = this.define.bind(this);\n    global.defineAsync = this.defineAsync.bind(this);\n    global.defineBlocking = this.defineBlocking.bind(this);\n\n    this.syncFunctions = {};\n    this.asyncFunctions = {};\n    this.blockingFunctions = {};\n\n    if (this.require) {\n      this.syncFunctions = SYNC_FUNCTIONS[this.require] = SYNC_FUNCTIONS[this.require] || {}\n      this.asyncFunctions = ASYNC_FUNCTIONS[this.require] = ASYNC_FUNCTIONS[this.require] || {}\n      this.blockingFunctions = BLOCKING_FUNCTIONS[this.require] = BLOCKING_FUNCTIONS[this.require] || {}\n\n      require(this.require);\n    }\n  }\n\n  define(name, fn) {\n    this.syncFunctions[name] = fn;\n  }\n\n  defineAsync(name, fn) {\n    this.asyncFunctions[name] = fn;\n  }\n\n  defineBlocking(name, fn) {\n    this.blockingFunctions[name] = (...args) => {\n      fn(...args);\n\n      return BLOCKING;\n    };\n  }\n\n  defines() {\n    return [\n      ...Object.entries(this.syncFunctions).map(([name, fn]) => `define('${name}');\\n`),\n      ...Object.entries(this.asyncFunctions).map(([name, fn]) => `defineAsync('${name}');\\n`),\n      ...Object.entries(this.blockingFunctions).map(([name, fn]) => `defineBlocking('${name}');\\n`)\n    ];\n  }\n\n  initialize() {\n    return new Promise((resolve, reject) => {\n      this.output = [];\n\n      const defines = this.defines();\n\n      const code = RUNTIME + '\\n' + this.defines().join('\\n') + this.template;\n\n      this.native.initialize(code, (json) => {\n        const result = tryParseJSON(json);\n\n        setImmediate(() => {\n          if (result && result.error) {\n            if (result.error.lineNumber != null) {\n              result.error.lineNumber -= (LINECOUNT + defines.length);\n            }\n\n            reject(result.error);\n          } else {\n            resolve(result && result.value);\n          }\n        });\n      }, this.dispatch.bind(this));\n    });\n  }\n\n  async eval(code) {\n    await this.initialize();\n\n    const result = await this.execute(code);\n\n    await this.finalize();\n\n    return {...result, output: this.output};\n  }\n\n  execute(code, callback) {\n    return new Promise((resolve, reject) => {\n      this.native.execute(code, (json) => {\n        let result = tryParseJSON(json);\n\n        if (result == null) {\n          result = { error: new Error('no result'), output: this.output };\n        }\n\n        setImmediate(() => {\n          resolve({...result, output: this.output});\n        });\n      }, this.dispatch.bind(this));\n    });\n  }\n\n  finalize() {\n    return new Promise((resolve) => {\n      this.native.finalize(() => {\n        setImmediate(resolve);\n      }, this.dispatch.bind(this));\n    });\n  }\n\n  // handle function calls from the sandbox\n  dispatch(invocation) {\n    const finish = (err, ...results) => {\n      const serialized = [\n        err != null ? {message: err.message} : null\n      ];\n\n      if (results && results.length) {\n        serialized.push.apply(serialized, results);\n      }\n\n      invocation.callback(invocation, JSON.stringify(serialized));\n    };\n\n    const parameters = tryParseJSON(invocation.args);\n\n    if (parameters == null) {\n      return finish(new Error('invalid invocation parameters'));\n    }\n\n    if (invocation.name === 'dispatchSync') {\n      return this.dispatchSync(parameters, finish);\n    } else if (invocation.name === 'dispatchAsync') {\n      return this.dispatchAsync(parameters, finish);\n    } else if (invocation.name === 'httpRequest') {\n      return this.httpRequest(...parameters, finish);\n    } else if (invocation.name === 'log') {\n      this.log(...parameters);\n      return finish(null);\n    } else if (invocation.name === 'error') {\n      this.error(...parameters);\n      return finish(null);\n    }\n\n    return finish(null);\n  }\n\n  log(...args) {\n    this.write({type: 'log', args});\n    console.log(...args);\n  }\n\n  error(...args) {\n    this.write({type: 'error', args});\n    console.error(...args);\n  }\n\n  write({type, args}) {\n    this.output.push({type, time: new Date(), message: util.format(...args)});\n  }\n\n  httpRequest(options, callback) {\n    request(options, (err, response, body) => {\n      if (response && Buffer.isBuffer(response.body)) {\n        response.body = body = response.body.toString('base64');\n      }\n\n      callback(err, response, body);\n    });\n  }\n\n  dispatchSync(args, callback) {\n    try {\n      const name = args[0];\n      const parameters = args.slice(1);\n      const fn = name && (this.syncFunctions[name] || this.blockingFunctions[name]);\n\n      if (!fn) {\n        return callback(new Error(`function named '${name}' does not exist`));\n      }\n\n      const result = fn(...[ ...parameters, callback ]);\n\n      if (result !== BLOCKING) {\n        callback(null, result);\n      }\n    } catch (err) {\n      callback(err);\n    }\n  }\n\n  dispatchAsync(args, callback) {\n    try {\n      const name = args[0];\n      const parameters = args.slice(1);\n      const fn = name && this.asyncFunctions[name];\n\n      if (!fn) {\n        return callback(new Error(`function named '${name}' does not exist`));\n      }\n\n      fn(...[ ...parameters, callback ]);\n    } catch (err) {\n      callback(err);\n    }\n  }\n}\n"],"file":"sandbox.js"}