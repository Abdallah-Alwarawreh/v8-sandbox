{"version":3,"sources":["../lib/sandbox.js"],"names":["TimeoutError","Error","isTimeout","Socket","constructor","socket","sandbox","console","log","data","toString","message","JSON","parse","callback","args","worker","send","type","id","respond","result","json","stringify","length","Buffer","byteLength","buffer","alloc","writeInt32LE","write","dispatch","ex","error","name","stack","resume","on","handleClose","handleData","handleError","handleDrain","handleTimeout","handleEnd","Sandbox","socketName","server","net","createServer","handleConnection","handleListening","listen","forkWorker","queue","kill","path","join","__dirname","process","platform","cwd","execute","code","context","timeout","wrappedCallback","called","push","executeNext","finishItem","item","pop","removeAllListeners","exitCode","executionTimeout","setTimeout","shutdown","close","value","setResult","timerID"],"mappings":"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","sourcesContent":["import path from 'path';\nimport { fork } from 'child_process';\nimport net from 'net';\nimport { v4 as uuid } from 'uuid';\n\nclass TimeoutError extends Error {\n  get isTimeout() {\n    return true;\n  }\n}\n\nclass Socket {\n  constructor(socket, sandbox) {\n    this.sandbox = sandbox;\n    this.socket = socket;\n    this.socket.on('close', this.handleClose);\n    this.socket.on('data', this.handleData);\n    this.socket.on('error', this.handleError);\n    this.socket.on('drain', this.handleDrain);\n    this.socket.on('timeout', this.handleTimeout);\n    this.socket.on('end', this.handleEnd);\n  }\n\n  handleClose = () => {\n    console.log('socket closed');\n  }\n\n  handleData = (data) => {\n    console.log('socket data', data.toString());\n\n    const message = JSON.parse(data);\n\n    const callback = (...args) => {\n      this.sandbox.worker.send({ type: 'callback', id: message.id, args });\n    };\n\n    const respond = (result) => {\n      const json = JSON.stringify({ id: message.id, result });\n      const length = Buffer.byteLength(json, 'utf8');\n      const buffer = Buffer.alloc(length + 4);\n  \n      buffer.writeInt32LE(length);\n      buffer.write(json, 4);\n  \n      console.log('writing json', json);\n      this.socket.write(buffer);\n    }\n\n    try {\n      this.sandbox.dispatch(message, respond, callback);\n    } catch (ex) {\n      return respond({\n        error: {\n          name: ex.name,\n          message: ex.message,\n          stack: ex.stack\n        }\n      });\n    }\n  }\n\n  handleError = (error) => {\n    console.log('socket error', error);\n  }\n\n  handleTimeout = () => {\n    console.log('socket timeout');\n  }\n\n  handleDrain = () => {\n    console.log('socket drain');\n    this.socket.resume();\n  }\n\n  handleEnd = () => {\n    console.log('socket end');\n  }\n}\n\nexport default class Sandbox {\n  constructor() {\n    this.id = uuid();\n\n    this.server = net.createServer();\n\n    this.server.on('close', this.handleClose);\n    this.server.on('connection', this.handleConnection);\n    this.server.on('error', this.handleError);\n    this.server.on('listening', this.handleListening);\n\n    this.server.listen(this.socketName);\n\n    this.forkWorker();\n\n    this.queue = [];\n  }\n\n  forkWorker() {\n    if (this.worker) {\n      this.worker.kill();\n      this.worker = null;\n    }\n\n    this.worker = fork(path.join(__dirname, 'worker'), [ this.socketName ]);\n  }\n\n  get socketName() {\n    return process.platform === 'win32' ? path.join('\\\\\\\\?\\\\pipe', process.cwd(), this.id)\n                                        : `/tmp/${ this.id }`;\n  }\n\n  handleClose = () => {\n    console.log('server closed');\n  }\n\n  handleConnection = (socket) => {\n    console.log('server connection');\n    this.socket = new Socket(socket, this);\n  }\n\n  handleError = (error) => {\n    console.log('server error', error);\n  }\n\n  handleListening = () => {\n    console.log('server listening', this.socketName);\n  }\n\n  execute({code, context, timeout}, callback) {\n    const wrappedCallback = (...args) => {\n      if (callback == null || callback.called) {\n        return;\n      }\n\n      callback.called = true;\n\n      callback(...args);\n    };\n\n    this.queue.push({code, context, timeout, callback: wrappedCallback});\n\n    this.executeNext();\n  }\n\n  finishItem() {\n    this.item = null;\n    this.executeNext();\n  }\n\n  executeNext() {\n    if (this.item || this.queue.length === 0) {\n      return;\n    }\n\n    this.item = this.queue.pop();\n\n    const { worker, item } = this;\n\n    worker.removeAllListeners();\n\n    worker.on('error', (error) => {\n      console.error('worker:error', error);\n\n      this.forkWorker();\n\n      item.callback({ error: new Error('worker error') });\n\n      this.finishItem();\n    });\n\n    this.worker.on('exit', () => {\n      console.error('worker:exit', worker.exitCode);\n    });\n\n    if (item.timeout > 0) {\n      worker.executionTimeout = setTimeout(() => {\n        worker.kill();\n\n        this.forkWorker();\n\n        item.callback({ error: new TimeoutError('timeout') });\n  \n        this.finishItem();\n      }, item.timeout);\n    }\n\n    this.worker.send({type: 'execute', code: item.code, context: JSON.stringify(item.context || {})});\n  }\n\n  shutdown() {\n    this.worker.send({ type: 'exit' });\n    this.server.close(() => {\n      console.log('server shutdown');\n    })\n  }\n\n  dispatch({ name, args }, respond, callback) {\n    if (name === 'setResult') {\n      return respond({ value: this.setResult(...args) });\n    } if (name === 'test') {\n      return respond({ value: args });\n    } else if (name === 'testAsync') {\n      const timerID = setTimeout(() => {\n        callback(null, 7171717);\n      });\n\n      return respond({ value: +timerID });\n    } else {\n      throw new Error(`${ name } is not a valid method`);\n    }\n  }\n\n  setResult(result) {\n    // this.worker.send({ type: 'exit' });\n    this.item.callback(result);\n    this.finishItem();\n  }\n}"],"file":"sandbox.js"}