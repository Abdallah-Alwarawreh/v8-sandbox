{"version":3,"sources":["../lib/sandbox.js"],"names":["Socket","constructor","socket","sandbox","console","log","data","toString","message","JSON","parse","callback","args","worker","send","type","id","respond","result","json","stringify","length","Buffer","byteLength","buffer","alloc","writeInt32LE","write","dispatch","error","resume","on","handleClose","handleData","handleError","handleDrain","handleTimeout","handleEnd","Sandbox","socketName","server","net","createServer","handleConnection","handleListening","listen","forkWorker","queue","kill","path","join","__dirname","process","platform","cwd","execute","code","context","timeout","wrappedCallback","called","push","executeNext","finishItem","item","pop","removeAllListeners","Error","exitCode","shutdown","close","name","value","setResult","timerID","setTimeout"],"mappings":"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","sourcesContent":["import path from 'path';\nimport { fork } from 'child_process';\nimport net from 'net';\nimport { v4 as uuid } from 'uuid';\n\nclass Socket {\n  constructor(socket, sandbox) {\n    this.sandbox = sandbox;\n    this.socket = socket;\n    this.socket.on('close', this.handleClose);\n    this.socket.on('data', this.handleData);\n    this.socket.on('error', this.handleError);\n    this.socket.on('drain', this.handleDrain);\n    this.socket.on('timeout', this.handleTimeout);\n    this.socket.on('end', this.handleEnd);\n  }\n\n  handleClose = () => {\n    console.log('socket closed');\n  }\n\n  handleData = (data) => {\n    console.log('socket data', data.toString());\n\n    const message = JSON.parse(data);\n\n    const callback = (...args) => {\n      this.sandbox.worker.send({ type: 'callback', id: message.id, args });\n    };\n\n    const respond = (result) => {\n      const json = JSON.stringify({ id: message.id, result });\n      const length = Buffer.byteLength(json, 'utf8');\n      const buffer = Buffer.alloc(length + 4);\n  \n      buffer.writeInt32LE(length);\n      buffer.write(json, 4);\n  \n      this.socket.write(buffer);\n    }\n\n    this.sandbox.dispatch(message, respond, callback);\n  }\n\n  handleError = (error) => {\n    console.log('socket error', error);\n  }\n\n  handleTimeout = () => {\n    console.log('socket timeout');\n  }\n\n  handleDrain = () => {\n    console.log('socket drain');\n    this.socket.resume();\n  }\n\n  handleEnd = () => {\n    console.log('socket end');\n  }\n}\n\nexport default class Sandbox {\n  constructor() {\n    this.id = uuid();\n\n    this.server = net.createServer();\n\n    this.server.on('close', this.handleClose);\n    this.server.on('connection', this.handleConnection);\n    this.server.on('error', this.handleError);\n    this.server.on('listening', this.handleListening);\n\n    this.server.listen(this.socketName);\n\n    this.forkWorker();\n\n    this.queue = [];\n  }\n\n  forkWorker() {\n    if (this.worker) {\n      this.worker.kill();\n      this.worker = null;\n    }\n\n    this.worker = fork(path.join(__dirname, 'worker'), [ this.socketName ]);\n  }\n\n  get socketName() {\n    return process.platform === 'win32' ? path.join('\\\\\\\\?\\\\pipe', process.cwd(), this.id)\n                                        : `/tmp/${ this.id }`;\n  }\n\n  handleClose = () => {\n    console.log('server closed');\n  }\n\n  handleConnection = (socket) => {\n    console.log('server connection');\n    this.socket = new Socket(socket, this);\n  }\n\n  handleError = (error) => {\n    console.log('server error', error);\n  }\n\n  handleListening = () => {\n    console.log('server listening', this.socketName);\n  }\n\n  execute({code, context, timeout}, callback) {\n    const wrappedCallback = (...args) => {\n      if (callback == null || callback.called) {\n        return;\n      }\n\n      callback.called = true;\n\n      callback(...args);\n    };\n\n    this.queue.push({code, context, timeout, callback: wrappedCallback});\n\n    this.executeNext();\n  }\n\n  finishItem() {\n    this.item = null;\n    this.executeNext();\n  }\n\n  executeNext() {\n    if (this.item || this.queue.length === 0) {\n      return;\n    }\n\n    this.item = this.queue.pop();\n\n    const { worker, item } = this;\n\n    worker.removeAllListeners();\n\n    worker.on('error', (error) => {\n      console.error('worker:error', error);\n\n      this.forkWorker();\n\n      item.callback({ error: new Error('worker error') });\n\n      this.finishItem();\n    });\n\n    this.worker.on('exit', () => {\n      console.error('worker:exit', worker.exitCode);\n    });\n\n    // if (timeout > 0) {\n    //   worker.executionTimeout = setTimeout(() => {\n    //     this.removeWorker(worker);\n    //     worker.kill();\n    //     callback({error: new TimeoutError('timeout')});\n    //   }, timeout);\n    // }\n\n    this.worker.send({type: 'execute', code: item.code, context: JSON.stringify(item.context || {})});\n  }\n\n  shutdown() {\n    this.worker.send({ type: 'exit' });\n    this.server.close(() => {\n      console.log('server shutdown');\n    })\n  }\n\n  dispatch({ name, args }, respond, callback) {\n    if (name === 'setResult') {\n      respond({ value: this.setResult(...args) });\n    } if (name === 'test') {\n      respond({ value: args });\n    } else if (name === 'testAsync') {\n      const timerID = setTimeout(() => {\n        callback(null, 7171717);\n      });\n\n      respond({ value: +timerID });\n    }\n  }\n\n  setResult(result) {\n    // this.worker.send({ type: 'exit' });\n    this.item.callback(result);\n    this.finishItem();\n  }\n}"],"file":"sandbox.js"}