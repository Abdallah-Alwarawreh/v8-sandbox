{"version":3,"sources":["../../lib/server/host.ts"],"names":["TimeoutError","Error","isTimeout","nextID","Host","constructor","require","fork","finish","error","message","timeout","Promise","resolve","callback","type","onInitialize","onExecute","socket","Socket","console","id","process","pid","server","net","createServer","on","handleConnection","handleError","cleanupSocket","listen","socketName","queue","async","processMessage","initializeTimeout","Timer","executeTimeout","functions","Functions","initialize","worker","initialized","push","template","output","result","execute","code","context","platform","path","join","cwd","dispatch","invocation","fail","respond","kill","__dirname","clear","removeAllListeners","send","fs","unlinkSync","ex","shutdown","clearTimers","close","args","start","handleTimeout","global","JSON","stringify"],"mappings":"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","sourcesContent":["import path from 'path';\nimport net from 'net';\nimport { fork, ChildProcess } from 'child_process';\nimport Timer from './timer';\nimport Socket from './socket';\nimport Functions from './functions';\nimport async from 'async';\nimport { once } from 'lodash';\n\nexport interface Log {\n  type: string;\n  time: Date;\n  message: string;\n}\n\nexport interface Result {\n  value?: any;\n  error?: {\n    name: string;\n    message: string;\n    stack: string;\n  };\n  output?: Log[];\n}\n\nexport interface Message {\n  type: 'initialize' | 'execute';\n  template?: string;\n  code?: string;\n  context?: any;\n  output: Log[];\n  // result: Result;\n  timeout: number;\n  callback: Function;\n}\n\nclass TimeoutError extends Error {\n  get isTimeout() {\n    return true;\n  }\n}\n\nlet nextID = 0;\n\nexport default class Host {\n  id: string;\n\n  template: string;\n\n  initializeTimeout: Timer;\n\n  executeTimeout: Timer;\n\n  server: net.Server;\n\n  worker: ChildProcess;\n\n  socket: Socket;\n\n  queue: async.AsyncQueue<Message>;\n\n  message: Message;\n\n  functions: Functions;\n\n  constructor({ require }) {\n    this.id = `v8-sandbox-socket-${ process.pid }-${ ++nextID }`;\n\n    this.server = net.createServer();\n    this.server.on('connection', this.handleConnection);\n    this.server.on('error', this.handleError);\n\n    this.cleanupSocket();\n\n    this.server.listen(this.socketName);\n\n    this.queue = async.queue(this.processMessage, 1);\n\n    this.initializeTimeout = new Timer();\n    this.executeTimeout = new Timer();\n\n    this.functions = new Functions(this, { require });\n\n    this.fork();\n  }\n\n  initialize({ timeout } = { timeout: null }): Promise<Result> {\n    return new Promise(resolve => {\n      if (this.worker && this.worker.initialized) {\n        return resolve({});\n      }\n\n      this.queue.push({\n        type: 'initialize',\n        template: this.template,\n        timeout,\n        output: [],\n        callback: (result: Result) => {\n          this.worker.initialized = true;\n\n          resolve(result);\n        }\n      });\n    });\n  }\n\n  async execute({ code, context, timeout }) {\n    const result = await this.initialize({ timeout });\n\n    if (result.error) {\n      return result;\n    }\n\n    return new Promise(resolve => {\n      this.queue.push({\n        type: 'execute',\n        code,\n        timeout,\n        context: context || {},\n        output: [],\n        callback: resolve\n      });\n    });\n  }\n\n  get socketName() {\n    return process.platform === 'win32' ? path.join('\\\\\\\\?\\\\pipe', process.cwd(), this.id)\n      : `/tmp/${ this.id }`;\n  }\n\n  dispatch(invocation, { fail, respond, callback }) {\n    this.functions.dispatch(invocation, { message: this.message, fail, respond, callback });\n  }\n\n  fork() {\n    this.kill();\n\n    this.worker = fork(path.join(__dirname, '..', 'client', 'worker'), [ this.socketName ]);\n\n    this.worker.on('error', (error) => {\n      this.fork();\n      this.finish({ error });\n    });\n  }\n\n  kill() {\n    this.initializeTimeout.clear();\n    this.executeTimeout.clear();\n\n    if (this.worker) {\n      this.worker.removeAllListeners();\n      this.worker.send({ type: 'exit' });\n      this.worker.kill();\n      this.worker = null;\n    }\n  }\n\n  cleanupSocket() {\n    try {\n      fs.unlinkSync(this.socketName);\n    } catch (ex) {\n      // silent\n    }\n  }\n\n  shutdown(callback) {\n    this.functions.clearTimers();\n\n    this.kill();\n\n    if (this.socket) {\n      this.socket.shutdown();\n    }\n\n    this.server.close(() => {\n      this.cleanupSocket();\n\n      if (callback) {\n        callback();\n      }\n    });\n  }\n\n  handleTimeout = () => {\n    this.fork();\n    this.finish({ error: new TimeoutError(`timeout: ${this.message.timeout }ms`) });\n  };\n\n  callback(id, args) {\n    this.worker.send({ type: 'callback', id, args });\n  }\n\n  processMessage = async (message: Message) => {\n    this.message = message;\n\n    return new Promise(resolve => {\n      this.message.callback = once(resolve);\n\n      switch (message.type) {\n        case 'initialize':\n          return this.onInitialize(message);\n        case 'execute':\n          return this.onExecute(message);\n        default:\n          this.finish({ error: new Error('invalid message') });\n      }\n    });\n  };\n\n  onInitialize({ template, timeout }: Message) {\n    this.initializeTimeout.start(timeout, this.handleTimeout);\n\n    this.worker.send({ type: 'initialize', template: template || '' });\n  }\n\n  onExecute({ code, context, timeout }: Message) {\n    this.executeTimeout.start(timeout, this.handleTimeout);\n\n    global.context = context;\n\n    this.worker.send({ type: 'execute', code, context: JSON.stringify(context) });\n  }\n\n  finish(result) {\n    this.functions.clearTimers();\n\n    if (this.message) {\n      this.message.callback({ ...result, output: this.message.output });\n    }\n  }\n\n  handleConnection = (socket) => {\n    this.socket = new Socket(socket, this);\n  };\n\n  handleError = (error) => {\n    console.error('server error', error);\n  };\n}\n"],"file":"host.js"}