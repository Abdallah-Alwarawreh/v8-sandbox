{"version":3,"sources":["../../lib/server/host.ts"],"names":["Host","EventEmitter","constructor","socketName","fork","emit","initializeTimeout","Timer","executeTimeout","kill","worker","path","join","__dirname","on","error","clear","removeAllListeners","send","type","process","item","initialize","execute","Error","template","timeout","start","handleTimeout","code","context","JSON","stringify","callback","id","args"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;;;;;AAEe,MAAMA,IAAN,SAAmBC,eAAnB,CAAgC;AAS7CC,EAAAA,WAAW,CAACC,UAAD,EAAa;AACtB;;AADsB;;AAAA;;AAAA;;AAAA;;AAAA,2CAsCR,MAAM;AACpB,WAAKC,IAAL;AACA,WAAKC,IAAL,CAAU,SAAV;AACD,KAzCuB;;AAGtB,SAAKF,UAAL,GAAkBA,UAAlB;AAEA,SAAKG,iBAAL,GAAyB,IAAIC,cAAJ,EAAzB;AACA,SAAKC,cAAL,GAAsB,IAAID,cAAJ,EAAtB;AAEA,SAAKH,IAAL;AACD;;AAEDA,EAAAA,IAAI,GAAG;AACL,SAAKK,IAAL;AAEA,SAAKC,MAAL,GAAc,yBAAKC,cAAKC,IAAL,CAAUC,SAAV,EAAqB,IAArB,EAA2B,QAA3B,EAAqC,QAArC,CAAL,EAAqD,CAAE,KAAKV,UAAP,CAArD,CAAd;AAEA,SAAKO,MAAL,CAAYI,EAAZ,CAAe,OAAf,EAAyBC,KAAD,IAAW;AACjC,WAAKX,IAAL;AACA,WAAKC,IAAL,CAAU,OAAV,EAAmBU,KAAnB;AACD,KAHD;AAKA,SAAKL,MAAL,CAAYI,EAAZ,CAAe,MAAf,EAAuB,MAAM;AAC3B,WAAKT,IAAL,CAAU,MAAV;AACD,KAFD;AAGD;;AAEDI,EAAAA,IAAI,GAAG;AACL,SAAKH,iBAAL,CAAuBU,KAAvB;AACA,SAAKR,cAAL,CAAoBQ,KAApB;;AAEA,QAAI,KAAKN,MAAT,EAAiB;AACf,WAAKA,MAAL,CAAYO,kBAAZ;AACA,WAAKP,MAAL,CAAYQ,IAAZ,CAAiB;AAAEC,QAAAA,IAAI,EAAE;AAAR,OAAjB;AACA,WAAKT,MAAL,CAAYD,IAAZ;AACA,WAAKC,MAAL,GAAc,IAAd;AACD;AACF;;AAODU,EAAAA,OAAO,CAACC,IAAD,EAAO;AACZ,YAAQA,IAAI,CAACF,IAAb;AACE,WAAK,YAAL;AACE,eAAO,KAAKG,UAAL,CAAgBD,IAAhB,CAAP;;AACF,WAAK,SAAL;AACE,eAAO,KAAKE,OAAL,CAAaF,IAAb,CAAP;;AACF;AACE,cAAM,IAAIG,KAAJ,CAAU,cAAV,CAAN;AANJ;AAQD;;AAEDF,EAAAA,UAAU,CAAC;AAAEG,IAAAA,QAAF;AAAYC,IAAAA;AAAZ,GAAD,EAAwB;AAChC,SAAKpB,iBAAL,CAAuBqB,KAAvB,CAA6BD,OAA7B,EAAsC,KAAKE,aAA3C;AAEA,SAAKlB,MAAL,CAAYQ,IAAZ,CAAiB;AAAEC,MAAAA,IAAI,EAAE,YAAR;AAAsBM,MAAAA,QAAQ,EAAEA,QAAQ,IAAI;AAA5C,KAAjB;AACD;;AAEDF,EAAAA,OAAO,CAAC;AAAEM,IAAAA,IAAF;AAAQC,IAAAA,OAAR;AAAiBJ,IAAAA;AAAjB,GAAD,EAA6B;AAClC,SAAKlB,cAAL,CAAoBmB,KAApB,CAA0BD,OAA1B,EAAmC,KAAKE,aAAxC;AAEA,SAAKlB,MAAL,CAAYQ,IAAZ,CAAiB;AAAEC,MAAAA,IAAI,EAAE,SAAR;AAAmBU,MAAAA,IAAnB;AAAyBC,MAAAA,OAAO,EAAEC,IAAI,CAACC,SAAL,CAAeF,OAAf;AAAlC,KAAjB;AACD;;AAEDG,EAAAA,QAAQ,CAACC,EAAD,EAAKC,IAAL,EAAW;AACjB,SAAKzB,MAAL,CAAYQ,IAAZ,CAAiB;AAAEC,MAAAA,IAAI,EAAE,UAAR;AAAoBe,MAAAA,EAApB;AAAwBC,MAAAA;AAAxB,KAAjB;AACD;;AA7E4C","sourcesContent":["import path from 'path';\nimport { fork, ChildProcess } from 'child_process';\nimport EventEmitter from 'events';\nimport Timer from './timer';\n\nexport default class Host extends EventEmitter {\n  socketName: string;\n\n  initializeTimeout: Timer;\n\n  executeTimeout: Timer;\n\n  worker: ChildProcess;\n\n  constructor(socketName) {\n    super();\n\n    this.socketName = socketName;\n\n    this.initializeTimeout = new Timer();\n    this.executeTimeout = new Timer();\n\n    this.fork();\n  }\n\n  fork() {\n    this.kill();\n\n    this.worker = fork(path.join(__dirname, '..', 'client', 'worker'), [ this.socketName ]);\n\n    this.worker.on('error', (error) => {\n      this.fork();\n      this.emit('error', error);\n    });\n\n    this.worker.on('exit', () => {\n      this.emit('exit');\n    });\n  }\n\n  kill() {\n    this.initializeTimeout.clear();\n    this.executeTimeout.clear();\n\n    if (this.worker) {\n      this.worker.removeAllListeners();\n      this.worker.send({ type: 'exit' });\n      this.worker.kill();\n      this.worker = null;\n    }\n  }\n\n  handleTimeout = () => {\n    this.fork();\n    this.emit('timeout');\n  };\n\n  process(item) {\n    switch (item.type) {\n      case 'initialize':\n        return this.initialize(item);\n      case 'execute':\n        return this.execute(item);\n      default:\n        throw new Error('invalid item');\n    }\n  }\n\n  initialize({ template, timeout }) {\n    this.initializeTimeout.start(timeout, this.handleTimeout);\n\n    this.worker.send({ type: 'initialize', template: template || '' });\n  }\n\n  execute({ code, context, timeout }) {\n    this.executeTimeout.start(timeout, this.handleTimeout);\n\n    this.worker.send({ type: 'execute', code, context: JSON.stringify(context) });\n  }\n\n  callback(id, args) {\n    this.worker.send({ type: 'callback', id, args });\n  }\n}\n"],"file":"host.js"}