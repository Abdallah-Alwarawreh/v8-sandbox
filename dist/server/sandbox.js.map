{"version":3,"sources":["../../lib/server/sandbox.ts"],"names":["TimeoutError","Error","isTimeout","nextID","Sandbox","constructor","require","template","httpEnabled","timersEnabled","memory","argv","fork","finish","error","message","timeout","Promise","resolve","callback","result","type","onInitialize","onExecute","socket","Socket","console","id","process","pid","initializeTimeout","Timer","executeTimeout","functions","Functions","start","code","signal","shutdown","initialize","queue","push","defines","join","output","initialized","execute","context","socketName","platform","path","cwd","dispatch","invocation","fail","respond","kill","execArgv","workerPath","__dirname","worker","on","running","clear","removeAllListeners","connected","send","cleanupSocket","fs","unlinkSync","ex","server","net","createServer","handleConnection","handleError","listen","async","processMessage","clearTimers","close","args","handleTimeout","global","JSON","stringify"],"mappings":"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","sourcesContent":["import path from 'path';\nimport net from 'net';\nimport fs from 'fs';\nimport { fork, ChildProcess } from 'child_process';\nimport async from 'async';\nimport { once } from 'lodash';\nimport onExit from 'signal-exit';\nimport Timer from './timer';\nimport Socket from './socket';\nimport Functions from './functions';\n\nexport interface Log {\n  type: string;\n  time: Date;\n  message: string;\n}\n\nexport interface Result {\n  value?: any;\n  error?: {\n    name: string;\n    message: string;\n    stack: string;\n  };\n  output?: Log[];\n}\n\nexport interface Message {\n  type: 'initialize' | 'execute';\n  template?: string;\n  code?: string;\n  context?: any;\n  output: Log[];\n  timeout: number;\n  callback: Function;\n}\n\nexport interface Options {\n  require?: string;\n  template?: string;\n  httpEnabled?: boolean;\n  timersEnabled?: boolean;\n  memory?: number;\n  argv?: string[];\n}\n\nexport class TimeoutError extends Error {\n  get isTimeout() {\n    return true;\n  }\n}\n\nlet nextID = 0;\n\nexport default class Sandbox {\n  id: string;\n\n  template: string;\n\n  initializeTimeout: Timer;\n\n  argv: string[];\n\n  executeTimeout: Timer;\n\n  server: net.Server;\n\n  worker: ChildProcess;\n\n  initialized: boolean;\n\n  socket: Socket;\n\n  queue: async.AsyncQueue<Message>;\n\n  message: Message;\n\n  functions: Functions;\n\n  running: boolean;\n\n  memory: number;\n\n  constructor({ require, template, httpEnabled, timersEnabled, memory, argv }: Options = {}) {\n    this.id = `v8-sandbox-${ process.pid }-${ ++nextID }`;\n\n    this.initializeTimeout = new Timer();\n    this.executeTimeout = new Timer();\n    this.memory = memory;\n    this.argv = argv ?? [];\n\n    this.template = template || '';\n    this.functions = new Functions(this, { require, httpEnabled, timersEnabled });\n\n    this.start();\n\n    onExit((code, signal) => {\n      this.shutdown(null);\n    });\n  }\n\n  initialize({ timeout } = { timeout: null }): Promise<Result> {\n    return new Promise(resolve => {\n      this.queue.push({\n        type: 'initialize',\n        template: [ this.functions.defines().join('\\n'), this.template ].join('\\n'),\n        timeout,\n        output: [],\n        callback: (result: Result) => {\n          this.initialized = true;\n\n          resolve(result);\n        }\n      });\n    });\n  }\n\n  async execute({ code, context, timeout }) {\n    this.start();\n\n    const result = await this.initialize({ timeout });\n\n    if (result.error) {\n      return result;\n    }\n\n    return new Promise(resolve => {\n      this.queue.push({\n        type: 'execute',\n        code,\n        timeout,\n        context: context || {},\n        output: [],\n        callback: (result: Result) => {\n          this.initialized = false;\n\n          resolve(result);\n        }\n      });\n    });\n  }\n\n  get socketName() {\n    return process.platform === 'win32' ? path.join('\\\\\\\\?\\\\pipe', process.cwd(), this.id)\n      : `/tmp/${ this.id }`;\n  }\n\n  dispatch(invocation, { fail, respond, callback }) {\n    this.functions.dispatch(invocation, { message: this.message, fail, respond, callback });\n  }\n\n  fork() {\n    this.kill();\n\n    const execArgv = [ ...this.argv ];\n\n    if (this.memory) {\n      execArgv.push(`--max-old-space-size=${this.memory}`);\n    }\n\n    const workerPath = path.join(__dirname, '..', 'client', 'worker');\n\n    this.worker = fork(workerPath, [ this.socketName ], { execArgv });\n\n    this.worker.on('error', (error) => {\n      this.fork();\n      this.finish({ error });\n    });\n\n    this.worker.on('exit', () => {\n      if (this.running) {\n        this.fork();\n      }\n\n      this.finish({ error: new Error('worker exited') });\n    });\n  }\n\n  kill() {\n    this.initializeTimeout.clear();\n    this.executeTimeout.clear();\n\n    if (this.worker) {\n      this.worker.removeAllListeners();\n\n      if (this.worker.connected) {\n        this.worker.send({ type: 'exit' });\n      }\n\n      this.worker.kill();\n      this.worker = null;\n      this.initialized = false;\n    }\n  }\n\n  cleanupSocket() {\n    try {\n      fs.unlinkSync(this.socketName);\n    } catch (ex) {\n      // silent\n    }\n  }\n\n  start() {\n    this.running = true;\n\n    if (this.server) {\n      return;\n    }\n\n    this.shutdown(null);\n\n    this.server = net.createServer();\n    this.server.on('connection', this.handleConnection);\n    this.server.on('error', this.handleError);\n\n    this.cleanupSocket();\n\n    this.server.listen(this.socketName);\n\n    this.queue = async.queue(this.processMessage, 1);\n\n    this.fork();\n  }\n\n  shutdown(callback) {\n    this.running = false;\n\n    this.functions.clearTimers();\n\n    this.kill();\n\n    if (this.socket) {\n      this.socket.shutdown();\n      this.socket = null;\n    }\n\n    if (this.server) {\n      this.server.close(() => {\n        if (callback) {\n          callback();\n        }\n      });\n\n      this.cleanupSocket();\n\n      this.server = null;\n    }\n  }\n\n  handleTimeout = () => {\n    this.fork();\n    this.finish({ error: new TimeoutError(`timeout: ${this.message.timeout }ms`) });\n  };\n\n  callback(id, args) {\n    this.worker.send({ type: 'callback', id, args });\n  }\n\n  processMessage = async (message: Message) => {\n    this.message = message;\n\n    return new Promise(resolve => {\n      const { callback } = this.message;\n\n      this.message.callback = once((result) => {\n        callback(result);\n        resolve();\n      });\n\n      switch (message.type) {\n        case 'initialize':\n          return this.onInitialize(message);\n        case 'execute':\n          return this.onExecute(message);\n        default:\n          this.finish({ error: new Error('invalid message') });\n      }\n    });\n  };\n\n  onInitialize({ template, timeout }: Message) {\n    if (this.initialized) {\n      return this.finish({});\n    }\n\n    this.initializeTimeout.start(timeout, this.handleTimeout);\n\n    this.worker.send({ type: 'initialize', template });\n  }\n\n  onExecute({ code, context, timeout }: Message) {\n    this.executeTimeout.start(timeout, this.handleTimeout);\n\n    global.context = context;\n\n    this.worker.send({ type: 'execute', code, context: JSON.stringify(context) });\n  }\n\n  finish(result) {\n    this.functions.clearTimers();\n\n    if (this.message) {\n      this.message.callback({ ...result, output: this.message.output });\n    }\n  }\n\n  handleConnection = (socket) => {\n    this.socket = new Socket(socket, this);\n  };\n\n  handleError = (error) => {\n    console.error('server error', error);\n  };\n}\n"],"file":"sandbox.js"}