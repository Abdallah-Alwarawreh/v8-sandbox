{"version":3,"sources":["../../lib/server/socket.ts"],"names":["tryParseJSON","value","JSON","parse","ex","Socket","EventEmitter","constructor","socket","sandbox","data","id","readInt32BE","json","toString","message","callback","args","isConnected","host","write","result","string","stringify","undefined","length","Buffer","byteLength","buffer","alloc","writeInt32BE","respond","fail","error","name","stack","Error","dispatch","console","resume","closed","worker","on","handleData","handleEnd","handleClose","handleError","handleDrain","shutdown","end","unref"],"mappings":"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","sourcesContent":["import EventEmitter from 'events';\nimport Sandbox from './sandbox';\nimport Worker from '../client/worker';\nimport net from 'net';\n\nfunction tryParseJSON(value) {\n  try {\n    return JSON.parse(value);\n  } catch (ex) {\n    return null;\n  }\n}\n\nexport default class Socket extends EventEmitter {\n  sandbox: Sandbox;\n\n  worker: Worker;\n\n  socket: net.Socket;\n\n  closed: boolean;\n\n  constructor(socket, sandbox) {\n    super();\n\n    this.sandbox = sandbox;\n    this.worker = sandbox.host.worker;\n    this.socket = socket;\n    this.socket.on('data', this.handleData);\n    this.socket.on('end', this.handleEnd);\n    this.socket.on('close', this.handleClose);\n    this.socket.on('error', this.handleError);\n    this.socket.on('drain', this.handleDrain);\n  }\n\n  shutdown() {\n    if (this.socket) {\n      this.closed = true;\n      this.socket.end();\n      this.socket.unref();\n    }\n  }\n\n  get isConnected() {\n    // make sure the current host is the host we started with. The host might've\n    // been replaced by the time this is invoked.\n    return !this.closed && this.worker === this.sandbox.host.worker;\n  }\n\n  handleData = (data) => {\n    const id = data.readInt32BE();\n    const json = data.toString('utf8', 4);\n\n    const message = tryParseJSON(json);\n\n    const callback = (...args) => {\n      if (this.isConnected) {\n        this.sandbox.host.callback(id, args);\n      }\n    };\n\n    const write = (result) => {\n      const string = JSON.stringify({ id, result: result || { value: undefined } });\n      const length = Buffer.byteLength(string, 'utf8');\n      const buffer = Buffer.alloc(length + 4);\n\n      buffer.writeInt32BE(length);\n      buffer.write(string, 4);\n\n      if (this.isConnected) {\n        this.socket.write(buffer);\n      }\n    };\n\n    const respond = (value) => {\n      write({ value });\n    };\n\n    const fail = (error) => {\n      write({\n        error: {\n          name: error.name,\n          message: error.message,\n          stack: error.stack\n        }\n      });\n    };\n\n    try {\n      if (message == null) {\n        throw new Error('invalid dispatch');\n      }\n\n      this.sandbox.dispatch(message, { fail, respond, callback });\n    } catch (ex) {\n      fail(ex);\n    }\n  };\n\n  handleError = (error) => {\n    console.error('socket error', error);\n  };\n\n  handleDrain = () => {\n    this.socket.resume();\n  };\n\n  handleClose = () => {\n    this.closed = true;\n  };\n\n  handleEnd = () => {\n    this.closed = true;\n  };\n}\n"],"file":"socket.js"}