{"version":3,"sources":["../lib/worker.js"],"names":["NativeSandbox","require","Sandbox","RUNTIME","fs","readFileSync","path","join","__dirname","toString","Worker","constructor","message","type","execute","callback","id","JSON","stringify","args","disconnect","process","off","worker","handleMessage","native","argv","console","log","connect","wrappedCode","code","result","send","connected","on"],"mappings":";;;;;;;AAAA;;AACA;;;;;;AAEA,MAAMA,aAAa,GAAGC,OAAO,CAAC,UAAD,CAAP,CAAoB,SAApB,EAA+BC,OAArD;;AAEA,MAAMC,OAAO,GAAGC,YAAGC,YAAH,CAAgBC,cAAKC,IAAL,CAAUC,SAAV,EAAqB,YAArB,CAAhB,EAAoDC,QAApD,EAAhB,C,CACA;;;AAEe,MAAMC,MAAN,CAAa;AAC1BC,EAAAA,WAAW,GAAG;AAAA,2CA2CGC,OAAD,IAAa;AAC3B,UAAIA,OAAO,CAACC,IAAR,KAAiB,SAArB,EAAgC;AAC9B,aAAKC,OAAL,CAAaF,OAAb;AACD,OAFD,MAEO,IAAIA,OAAO,CAACC,IAAR,KAAiB,UAArB,EAAiC;AACtC,aAAKE,QAAL,CAAcH,OAAO,CAACI,EAAtB,EAA0BC,IAAI,CAACC,SAAL,CAAeN,OAAO,CAACO,IAAvB,CAA1B;AACD,OAFM,MAEA,IAAIP,OAAO,CAACC,IAAR,KAAiB,MAArB,EAA6B;AAClC,aAAKO,UAAL;AACAC,QAAAA,OAAO,CAACC,GAAR,CAAY,SAAZ,EAAuBC,MAAM,CAACC,aAA9B;AACD;AACF,KApDa;;AACZ,SAAKC,MAAL,GAAc,IAAIzB,aAAJ,CAAkBqB,OAAO,CAACK,IAAR,CAAa,CAAb,CAAlB,CAAd;AACD;;AAEDZ,EAAAA,OAAO,CAACF,OAAD,EAAU;AACfe,IAAAA,OAAO,CAACC,GAAR,CAAY,WAAZ,EAAyBP,OAAO,CAACK,IAAR,CAAa,CAAb,CAAzB,EAA0Cd,OAA1C;AAEA,SAAKiB,OAAL;AAEA,UAAMC,WAAW,GAAI;uBACDb,IAAI,CAACC,SAAL,CAAeN,OAAO,CAACmB,IAAvB,CAA8B;;KADlD;AAKA,UAAMA,IAAI,GAAG,CAAE5B,OAAF,EAAW2B,WAAX,EAAyBvB,IAAzB,CAA8B,IAA9B,CAAb;AAEA,SAAKkB,MAAL,CAAYX,OAAZ,CAAoBiB,IAApB,EAA2BC,MAAD,IAAY;AACpCX,MAAAA,OAAO,CAACY,IAAR,CAAa;AAAEpB,QAAAA,IAAI,EAAE,QAAR;AAAkBmB,QAAAA;AAAlB,OAAb;AACD,KAFD;AAGD;;AAEDH,EAAAA,OAAO,GAAG;AACR,QAAI,KAAKK,SAAT,EAAoB;AAClB;AACD;;AAED,SAAKT,MAAL,CAAYI,OAAZ;AACA,SAAKK,SAAL,GAAiB,IAAjB;AACD;;AAEDd,EAAAA,UAAU,GAAG;AACX,QAAI,CAAC,KAAKc,SAAV,EAAqB;AACnB;AACD;;AAED,SAAKT,MAAL,CAAYL,UAAZ;AACA,SAAKc,SAAL,GAAiB,KAAjB;AACD;;AAEDnB,EAAAA,QAAQ,CAACC,EAAD,EAAKJ,OAAL,EAAc;AACpB,SAAKa,MAAL,CAAYV,QAAZ,CAAqBC,EAArB,EAAyBJ,OAAzB;AACD;;AA1CyB;;;AAwD5B,MAAMW,MAAM,GAAG,IAAIb,MAAJ,EAAf;AAEAW,OAAO,CAACc,EAAR,CAAW,SAAX,EAAsBZ,MAAM,CAACC,aAA7B","sourcesContent":["import fs from 'fs';\nimport path from 'path';\n\nconst NativeSandbox = require('bindings')('sandbox').Sandbox;\n\nconst RUNTIME = fs.readFileSync(path.join(__dirname, 'runtime.js')).toString();\n// const LINECOUNT = RUNTIME.split('\\n').length;\n\nexport default class Worker {\n  constructor() {\n    this.native = new NativeSandbox(process.argv[2]);\n  }\n\n  execute(message) {\n    console.log('executing', process.argv[2], message);\n\n    this.connect();\n\n    const wrappedCode = `\n      global._code = ${ JSON.stringify(message.code) };\n      global._execute();\n    `;\n\n    const code = [ RUNTIME, wrappedCode ].join('\\n');\n\n    this.native.execute(code, (result) => {\n      process.send({ type: 'result', result });\n    });\n  }\n\n  connect() {\n    if (this.connected) {\n      return;\n    }\n\n    this.native.connect();\n    this.connected = true;\n  }\n\n  disconnect() {\n    if (!this.connected) {\n      return;\n    }\n\n    this.native.disconnect();\n    this.connected = false;\n  }\n\n  callback(id, message) {\n    this.native.callback(id, message);\n  }\n\n  handleMessage = (message) => {\n    if (message.type === 'execute') {\n      this.execute(message);\n    } else if (message.type === 'callback') {\n      this.callback(message.id, JSON.stringify(message.args));\n    } else if (message.type === 'exit') {\n      this.disconnect();\n      process.off('message', worker.handleMessage);\n    }\n  }\n}\n\nconst worker = new Worker();\n\nprocess.on('message', worker.handleMessage);"],"file":"worker.js"}