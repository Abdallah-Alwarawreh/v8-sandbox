{"version":3,"sources":["../lib/worker.js"],"names":["NativeSandbox","require","Sandbox","RUNTIME","fs","readFileSync","path","join","__dirname","toString","Worker","constructor","message","console","log","JSON","parse","process","send","type","execute","callback","id","stringify","args","off","worker","handleMessage","native","argv","code","result","on"],"mappings":";;;;;;;AAAA;;AACA;;;;;;AAEA,MAAMA,aAAa,GAAGC,OAAO,CAAC,UAAD,CAAP,CAAoB,SAApB,EAA+BC,OAArD;;AAEA,MAAMC,OAAO,GAAGC,YAAGC,YAAH,CAAgBC,cAAKC,IAAL,CAAUC,SAAV,EAAqB,YAArB,CAAhB,EAAoDC,QAApD,EAAhB,C,CACA;;;AAEe,MAAMC,MAAN,CAAa;AAC1BC,EAAAA,WAAW,GAAG;AAAA,kCAkBNC,OAAD,IAAa;AAClBC,MAAAA,OAAO,CAACC,GAAR,CAAY,aAAZ;AACAF,MAAAA,OAAO,GAAGG,IAAI,CAACC,KAAL,CAAWJ,OAAX,CAAV;AAEAK,MAAAA,OAAO,CAACC,IAAR,CAAa;AAAEC,QAAAA,IAAI,EAAE,UAAR;AAAoBP,QAAAA;AAApB,OAAb;AACD,KAvBa;;AAAA,2CAyBGA,OAAD,IAAa;AAC3B,UAAIA,OAAO,CAACO,IAAR,KAAiB,SAArB,EAAgC;AAC9B,aAAKC,OAAL,CAAaR,OAAb;AACD,OAFD,MAEO,IAAIA,OAAO,CAACO,IAAR,KAAiB,UAArB,EAAiC;AACtC,aAAKE,QAAL,CAAcT,OAAO,CAACU,EAAtB,EAA0BP,IAAI,CAACQ,SAAL,CAAeX,OAAO,CAACY,IAAvB,CAA1B;AACD,OAFM,MAEA,IAAIZ,OAAO,CAACO,IAAR,KAAiB,MAArB,EAA6B;AAClCF,QAAAA,OAAO,CAACQ,GAAR,CAAY,SAAZ,EAAuBC,MAAM,CAACC,aAA9B;AACD;AACF,KAjCa;;AACZ,SAAKC,MAAL,GAAc,IAAI5B,aAAJ,CAAkBiB,OAAO,CAACY,IAAR,CAAa,CAAb,CAAlB,CAAd;AACD;;AAEDT,EAAAA,OAAO,CAACR,OAAD,EAAU;AACfC,IAAAA,OAAO,CAACC,GAAR,CAAY,WAAZ,EAAyBG,OAAO,CAACY,IAAR,CAAa,CAAb,CAAzB,EAA0CjB,OAA1C;AAEA,UAAMkB,IAAI,GAAG,CAAE3B,OAAF,EAAWS,OAAO,CAACkB,IAAnB,EAA0BvB,IAA1B,CAA+B,IAA/B,CAAb;AAEA,SAAKqB,MAAL,CAAYR,OAAZ,CAAoBU,IAApB,EAA2BC,MAAD,IAAY;AACpCd,MAAAA,OAAO,CAACC,IAAR,CAAa;AAAEC,QAAAA,IAAI,EAAE,QAAR;AAAkBY,QAAAA;AAAlB,OAAb;AACD,KAFD,EAEG,KAAKb,IAFR;AAGD;;AAEDG,EAAAA,QAAQ,CAACC,EAAD,EAAKV,OAAL,EAAc;AACpB,SAAKgB,MAAL,CAAYP,QAAZ,CAAqBC,EAArB,EAAyBV,OAAzB;AACD;;AAjByB;;;AAqC5B,MAAMc,MAAM,GAAG,IAAIhB,MAAJ,EAAf;AAEAO,OAAO,CAACe,EAAR,CAAW,SAAX,EAAsBN,MAAM,CAACC,aAA7B","sourcesContent":["import fs from 'fs';\nimport path from 'path';\n\nconst NativeSandbox = require('bindings')('sandbox').Sandbox;\n\nconst RUNTIME = fs.readFileSync(path.join(__dirname, 'runtime.js')).toString();\n// const LINECOUNT = RUNTIME.split('\\n').length;\n\nexport default class Worker {\n  constructor() {\n    this.native = new NativeSandbox(process.argv[2]);\n  }\n\n  execute(message) {\n    console.log('executing', process.argv[2], message);\n\n    const code = [ RUNTIME, message.code ].join('\\n');\n\n    this.native.execute(code, (result) => {\n      process.send({ type: 'result', result });\n    }, this.send);\n  }\n\n  callback(id, message) {\n    this.native.callback(id, message);\n  }\n\n  send = (message) => {\n    console.log('SENDING!!!!')\n    message = JSON.parse(message);\n\n    process.send({ type: 'dispatch', message });\n  }\n\n  handleMessage = (message) => {\n    if (message.type === 'execute') {\n      this.execute(message);\n    } else if (message.type === 'callback') {\n      this.callback(message.id, JSON.stringify(message.args));\n    } else if (message.type === 'exit') {\n      process.off('message', worker.handleMessage);\n    }\n  }\n}\n\nconst worker = new Worker();\n\nprocess.on('message', worker.handleMessage);"],"file":"worker.js"}